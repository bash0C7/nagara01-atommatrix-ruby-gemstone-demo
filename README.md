# Ruby Gemstoneデモ - 振動応答型LEDパターンシミュレーション

ATOM MatrixでルビーのGemstone（宝石）型パターンを加速度センサーの動きに応じて光らせるインタラクティブなデモです。

## 概要

このプロジェクトは、PicoRuby (R2P2-ESP32)を使用してATOM Matrixの5x5 LEDマトリックスでルビーの宝石型パターンを表示するデモンストレーションです。内蔵MPU6886加速度センサーの値に基づいて、LEDパターンがリアルタイムで移動し、動きの激しさに応じて色が変化します。

### 主な機能
- **加速度センサー**: MPU6886で傾き・振動を検出
- **動的LEDパターン**: 5x5マトリックスでルビー型パターンを表示
- **リアルタイム応答**: センサー値に基づくパターン移動と色変化
- **キャリブレーション**: ボタン押下で基準値を再設定
- **メモリ最適化**: 組み込みシステム向けの効率的な実装

## デモの動作

1. **静止時**: 赤色のルビー型パターンが中央に表示
2. **軽い動き**: オレンジ色に変化してパターンが移動
3. **激しい動き**: 青紫色に変化して高速移動
4. **キャリブレーション**: ボタン押下で基準位置をリセット

## LEDパターンのカスタマイズ

`src_components/R2P2-ESP32/storage/home/app.rb`の`pattern_rows`配列でLEDパターンを二進数で直感的に設定できます：

```ruby
pattern_rows = [
  0b01110,  # □■■■□
  0b11111,  # ■■■■■  ← ルビー型（デフォルト）
  0b01110,  # □■■■□
  0b00100,  # □□■□□
  0b00000   # □□□□□
]
```

### その他のパターン例

**ハート型**：
```ruby
pattern_rows = [
  0b01010,  # □■□■□
  0b11111,  # ■■■■■
  0b01110,  # □■■■□
  0b00100,  # □□■□□
  0b00000   # □□□□□
]
```

**十字型**：
```ruby
pattern_rows = [
  0b00100,  # □□■□□
  0b00100,  # □□■□□
  0b11111,  # ■■■■■
  0b00100,  # □□■□□
  0b00100   # □□■□□
]
```

## セットアップとビルド

### 必要環境

**ハードウェア**:
- **ATOM Matrix ESP32デバイス** (必須) - M5Stack ATOM Matrix
  - ESP32-PICO-D4搭載、5x5 LEDマトリックス内蔵
  - MPU6886加速度センサー内蔵

**ソフトウェア**:
- **ESP-IDF** (`$HOME/esp/esp-idf/`にインストール) - 必須
  - インストール手順: https://docs.espressif.com/projects/esp-idf/en/stable/esp32/get-started/index.html#manual-installation
- **Homebrew** (macOS)

## クイックスタート

1. **リポジトリをクローン**:
   ```bash
   git clone [このリポジトリのURL]
   cd nagara01-atommatrix-ruby-gemstone-demo
   ```

2. **初期化**:
   ```bash
   rake init
   ```

3. **ATOM MatrixをUSBでPCに接続**

4. **ビルド・書き込み・実行**:
   ```bash
   rake
   ```
   ルビー型のLEDパターンが加速度センサーに応じて動作開始！

5. **終了方法**:
   - ターミナルで `Ctrl+]` で終了して、USBケーブルを抜く

6. **モバイル運用**:
   USBモバイルバッテリーに接続すればPCレスで単体動作可能

### その他の開発用コマンド

```bash
# 開発用コマンド一覧
rake -T
```

## ハードウェア仕様

- **ESP32-PICO-D4**: 240MHz デュアルコア
- **5×5 LED Matrix**: WS2812C (GPIO 27)
- **MPU6886 IMU**: I2C接続 (SDA:25, SCL:21, アドレス:0x68)
- **プログラマブルボタン**: GPIO 39

## プログラム構造

### メインファイル

**`src_components/R2P2-ESP32/storage/home/app.rb`** - メインプログラム
- LEDパターンの定義とカスタマイズはこのファイルを編集

### 主要コンポーネント

- **LED制御**: WS2812ドライバーによる5x5マトリックス制御
- **センサー処理**: MPU6886加速度センサーから3軸データ取得
- **パターン描画**: 二進数配列からLED位置を効率的に計算
- **動き検出**: 加速度の変化量で動きの強度を判定
- **色変化システム**: 動きの強度に応じた3段階の色変化

### メモリ効率化

- 事前割り当て配列でガベージコレクション負荷を軽減
- 平方根計算を避けて二乗値で距離判定
- 整数演算中心の高速処理

## トラブルシューティング

### よくある問題

1. **LEDが光らない**: GPIO 27の配線確認、電源供給確認
2. **センサーが反応しない**: I2C接続確認(SDA:25, SCL:21)
3. **パターンが正しく表示されない**: `pattern_rows`の二進数設定確認

### デバッグ出力

プログラム実行中にシリアル出力で動作状態を確認できます：
- `S`: 静止状態
- `G`: 軽い動き
- `D`: 激しい動き

## カスタマイズのヒント

1. **パターン変更**: `pattern_rows`配列を編集
2. **色調整**: `colors`配列のRGB値を変更
3. **感度調整**: 動き検出の閾値`64`, `625`, `2400`を調整
4. **更新レート**: `sleep_ms 50`で描画間隔を調整
